<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>网站后台管理模版</title>
    <link rel="stylesheet" type="text/css"
          href="/layui2/css/layui.css" />
    <link rel="stylesheet" type="text/css" href="/css/admin2.css" />

</head>

<body>
<div class="page-content-wrap" id="studentSearch">
    <h5 style="text-align:center;font-size: 20px;line-height: 25px;color:#666">商品报损管理界面</h5>
    <hr>

    <form class="layui-form" action="">
        <div class="layui-inline">
            <label class="layui-form-label">单号</label>
            <div class="layui-inline">
                <input type="text" id="purchasenum" placeholder="请输入单号"
                       autocomplete="off" name="damageNumber" class="layui-input" />

            </div>
        </div>

        <div class="layui-inline">
            <label class="layui-form-label">开单日期</label>
            <div class="layui-input-inline">
                <input type="text" class="layui-input" name="damageDate" id="test5" placeholder="yyyy-MM-dd">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">备注</label>
            <div class="layui-input-inline">
                <input type="text" id="purchaseremark" placeholder="备注"
                       autocomplete="off" class="layui-input" name="remarks">
            </div>
        </div>

        <div class="layui-inline">
            <div class="layui-inline">
                <button type="submit" class="layui-btn layui-btn-normal" lay-submit="" lay-filter="demo1">提交</button>
            </div>
        </div>
    </form>
    <div class="layui-form-item">
        <!-- <div class="layui-inline tool-btn">

               <button class="layui-btn layui-btn-small site-demo-active"
                       data-type="tabAdd">
                   <i class="layui-icon">&#xe654;</i>
               </button>
             &lt;!&ndash; 				<button
                                 class="layui-btn layui-btn-small layui-btn-warm listOrderBtn hidden-xs"
                                 data-url="/admin/category/listorderall.html">
                                 <i class="iconfont">&#xe656;</i>
                             </button> &ndash;&gt;
         </div>-->
        <!-- <div class="layui-inline">
             <input type="text" id="studentNameSearch" placeholder="请输入商品名称"
                    autocomplete="off" class="layui-input">

         </div>
         <button class="layui-btn layui-btn-normal site-demo-active"
                 data-type="search" id="searchStudent">搜索
         </button>-->
        <button class="layui-btn layui-btn-small site-demo-active"
                data-type="tabAdd">
            <i class="layui-icon">选择商品</i>
        </button>
        <!--<table class="layui-table"
              id="test10"
               lay-filter="demo">
            <thead>
            <tr>
                <th lay-data="{type:'checkbox', }"></th>
                <th lay-data="{field:'id',sort: true}">id</th>
                <th lay-data="{field:'code'}">商品编号</th>
                <th lay-data="{field:'name'}">商品名称</th>
                <th lay-data="{field:'model'}">型号</th>
                <th lay-data="{field:'purchasingPrice'}">采购价</th>
                <th lay-data="{field:'sellingPrice'}">出售价</th>
                <th lay-data="{field:'minNum'}">库存下限</th>
                <th lay-data="{field:'producer'}">生产厂家</th>
                &lt;!&ndash;  <th lay-data="{fixed: 'right', width:220, align:'left', toolbar: '#barDemo'}"></th>&ndash;&gt;
            </tr>
            </thead>
        </table>-->
    </div>
    <table class="layui-hide" id="demo"  lay-filter="demo"></table>
    <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <!-- <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>-->
    </script>

    <!--  <script type="text/html" id="barDemo">
          <a class="layui-btn layui-btn-normal layui-btn-sm" lay-event="detail">查看</a>
          &lt;!&ndash; <a class="layui-btn layui-btn-sm" lay-event="edit">编辑</a>&ndash;&gt;
          <a class="layui-btn layui-btn-danger layui-btn-sm" lay-event="del">删除</a>
      </script>-->
    <hr></hr>
    <h5 style="text-align: center;">@leefm666毕业设计仓库管理系统</h5>
</div>

</body>
<div id="dg" style="display: none">
    <div class="layui-inline tool-btn">
        <button class="layui-btn layui-btn-small site-demo-active"
                data-type="tabAdd2" id="tabAdd2">
            <i class="layui-icon">选择</i>
        </button>
    </div>
    <table class="layui-table"
           lay-data="{ url:'/Goods/selectAllGoods3',page:true, id:'idTest1'}"
           lay-filter="demo2">
        <thead>
        <tr>
            <th lay-data="{type:'checkbox', }"></th>
            <th lay-data="{field:'id',sort: true}">id</th>
            <th lay-data="{field:'code'}">商品编号</th>
            <th lay-data="{field:'name'}">商品名称</th>
            <th lay-data="{field:'model'}">型号</th>
            <th lay-data="{field:'purchasingPrice'}">采购价</th>
            <th lay-data="{field:'sellingPrice'}">出售价</th>
            <th lay-data="{field:'minNum'}">库存下限</th>
            <th lay-data="{field:'producer'}">生产厂家</th>
            <!--    <th lay-data="{fixed: 'right', width:220, align:'left', toolbar: '#barDemo'}"></th>-->
        </tr>
        </thead>
    </table>
    <script type="text/html" id="barDemo1">
        <a class="layui-btn layui-btn-normal layui-btn-sm" lay-event="detail">查看</a>
        <a class="layui-btn layui-btn-sm" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-sm" lay-event="del">删除</a>
    </script>
</div>
<div id="dg1" style="display: none">
    <form class="layui-form" action="" id="">
        <div class="layui-form-item">
            <label class="layui-form-label">商品编号</label>
            <div class="layui-input-block">
                <input type="text" name="code" readonly="readonly"  id="code1" lay-verify="code"
                       autocomplete="off" placeholder="请输入id" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">商品名称</label>
            <div class="layui-input-block">
                <input type="text" name="name"  id="name1" lay-verify="name"
                       placeholder="请输入商品名称" readonly="readonly" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">商品类型</label>
            <div class="layui-input-block">
                <input type="text" name="model"  id="model1" lay-verify="model"
                       placeholder="请输入商品类型" readonly="readonly" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">商品单位</label>
            <div class="layui-input-block">
                <input type="text" name="unit"  id="unit1" lay-verify="unit"
                       placeholder="请输入商品单位" readonly="readonly" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">上次进价</label>
            <div class="layui-input-block">
                <input type="text" name="lastPurchasingPrice"  id="lastPurchasingPrice1" lay-verify="lastPurchasingPrice"
                       placeholder="请输入商品类型" readonly="readonly" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">当前库存</label>
            <div class="layui-input-block">
                <input type="text" name="inventoryQuantity"  id="inventoryQuantity1" lay-verify="inventoryQuantity"
                       placeholder="请输入商品类型" readonly="readonly" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">单价</label>
            <div class="layui-input-block">
                <input type="text" name="sellingPrice"  id="sellingPrice1" lay-verify="number"
                       placeholder="请输入数量"  autocomplete="off" class="layui-input" >
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">数量</label>
            <div class="layui-input-block">
                <input type="text" name="num"  id="num1" lay-verify="number"
                       placeholder="请输入数量"  autocomplete="off" class="layui-input" >
            </div>
        </div>
        <div class="layui-form-item m-login-btn" style="text-align:center">
            <div class="layui-inline">
                <button class="layui-btn layui-btn-normal" lay-submit lay-filter="editStudent">保存</button>
            </div>
            <div class="layui-inline">
                <button type="reset" class="layui-btn layui-btn-primary  site-demo-active"
                        data-type="resetEdit">关闭</button>
            </div>
        </div>
    </form>
</div>
<script src="/layui2/layui.all.js" type="text/javascript"
        charset="utf-8"></script>
<script>
    layui.use(['table','laydate','form'], function() {
        var $ = layui.jquery,
            table = layui.table,
            laydate=layui.laydate,
            form=layui.form;
        var tabledata;
        var data10;
        var datatable=null;
        var param

        form.on('submit(demo1)', function(data){
            var flag=1;
            if(!datatable){
                layer.msg("选择商品")
            }else{
                for(var i in datatable){
                    if(datatable[i].num==''||datatable[i].num==null){
                        layer.msg("请编辑数量")
                        flag=0;
                    }
                }
                if(flag==1){

                    var str=JSON.stringify(data.field);
                    var param1 = JSON.parse(str);
                    var purchaseListGoodsList=JSON.stringify(datatable);
                    $.ajax({
                        url: '/DamageList/insertPurchaseList',
                        dataType: 'json',
                        type: 'post',
                        data:param1,
                        success: function (data) {
                        }
                    });
                    console.log("datatable");
                    console.log(datatable);
                    $.ajax({
                        url: '/DamageList/insertDamageGoods',
                        dataType: 'json',
                        type: 'post',
                        data:{damageListGoodsList:purchaseListGoodsList},
                        success: function (data) {
                            window.location.href="/route/stock/damage"
                            window.alert("保存成功")
                        }
                    });
                }
            }

            return false;
        });
        //日期时间选择器
        laydate.render({
            elem: '#test5',
            format:'yyyy-MM-dd'
        });
        //监听表格复选框选择
        table.on('checkbox(demo)', function(obj) {
            console.log(obj)
        });

        //下拉框获取
        $.ajax({
            url: '/Supplier/selectAll',
            dataType: 'json',
            type: 'post',
            success: function (data) {
                $.each(data, function (index, item) {
                    $('#otype').append(new Option(item.name, item.id));// 下拉菜单里添加元素
                });
                layui.form.render("select");
            }
        });
        //单号获取
        $.ajax({
            url: '/DamageList/getTodayMaxDamageListNumber',
            // contentType: "application/json; charset=utf-8",
            dataType: 'text',
            type: 'post',
            success: function (data) {
                $('#purchasenum').val(data);
                console.log(data);
            },
            error:function () {
                console.log("shibie");
            }
        });
        form.verify({
            num1:[
                /^[\d]{3,6}$/,
                '学号必须6到10位数字'
            ]
        });
        form.on('submit(editStudent)', function(data){
            var str=JSON.stringify(data.field);
            var param = JSON.parse(str);
            layui.table.reload('demo',{page:{curr:1}});
            $.ajax({
                //几个参数需要注意一下
                type: "POST",//方法类型
                dataType: "json",//预期服务器返回的数据类型
                url: "/userInfo/updateUser",//url
                // contentType:'application/json;charset=UTF-8',
                data: param,
                success: function (result) {
                    if (result.code == "0") {
                        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                        parent.layer.close(index);

                        parent.layer.msg('编辑商品信息成功');

                        // parent.layui.table.reload('idTest',{page:{curr:1}});
                        layui.table.reload('demo',{page:{curr:1}});
                    }else{
                        layer.msg('编辑商品失败', {
                            icon: 5
                        });
                    }

                },
                error : function() {
                    layer.msg('服务器错误', {
                        icon: 5
                    });
                }
            });

            return false;
        });
        //监听工具条
        table.on('tool(demo)', function(obj) {
            var data = obj.data;
            if (obj.event === 'detail') {
                var detailFrom = layui.layer.open({
                    title : "查看用户信息",
                    type : 2,
                    content : "/route/purchase/purchasedetail",//弹出层页面
                    area: ['500px', '300px'],
                    success : function(layero, index){
                        var body = layui.layer.getChildFrame('body', index);
                        body.find("#id").text(data.id);
                        body.find("#code").text(data.code);
                        body.find("#name").text(data.name);
                        body.find("#model").text(data.model);
                        body.find("#purchasingPrice").text(data.purchasingPrice);
                        body.find("#sellingPrice").text(data.sellingPrice);
                        body.find("#minNum").text(data.minNum);
                        body.find("#producer").text(data.producer);
                    }});
            }
            if (obj.event === 'del') {
                layer.confirm('真的删除该学生吗？', function(index) {
                    var data = obj.data;
                    $.ajax({
                        //几个参数需要注意一下
                        type: "POST",//方法类型
                        dataType: "json",//预期服务器返回的数据类型
                        url: "/userInfo/deleteUser",//url
                        data: data,
                        success: function (result) {
                            if (result.code == "0") {
                                layer.close(index);
                                layer.msg('删除用户成功');
                                layui.table.reload('idTest',{page:{curr:1}});
                            }else{
                                layer.msg('删除用户失败', {
                                    icon: 5
                                });
                            }
                        },
                        error : function() {
                            layer.msg('服务器错误', {
                                icon: 5
                            });
                        }
                    });
                });
            }
            if (obj.event === 'edit') {
                var data=obj.data;
                layer.open({
                    type: 1,
                    title: '商品信息选择',
                    shadeClose: true,
                    shade: false,
                    resize:true,
                    /*    maxmin: true,  *///开启最大化最小化按钮
                    area: ['800px', '400px'],
                    // content: '/studentAdd.html'
                    content: $('#dg1')
                });
                $("#code1").val(data.code);
                $("#name1").val(data.name);
                $("#model1").val(data.model);
                $("#unit1").val(data.unit);
                $("#lastPurchasingPrice1").val(data.lastPurchasingPrice);
                $("#inventoryQuantity1").val(data.inventoryQuantity);
                $("#sellingPrice1").val(data.lastPurchasingPrice);
                var sellingPrice=$("#sellingPrice1").val();
                var num=$("#num1").val();
                // var total=num*(data.sellingPrice);
                var total=num*sellingPrice;
                console.log(num);
                console.log(total);
                console.log(obj);
                console.log(data);
                console.log("datatable");
                console.log(datatable);
                for(var i in datatable){
                    if(datatable[i].code==data.code){
                        datatable[i].num=num;
                        datatable[i].total= total;
                    }
                }
                var alltotal=0;
                for(var i in datatable){
                    alltotal=datatable[i].total+alltotal;
                }
                console.log("alltotal");
                console.log(alltotal);
                $("#shouldprice").val(alltotal);
                param=datatable;
                table.render({
                    elem: '#demo'
                    ,cols:[
                        [ //标题栏
                            {field: 'id', title: 'id', sort: true}
                            ,{field: 'code', title: '商品编码'}
                            ,{field: 'name', title: '商品编码'}
                            ,{field: 'model', title: '商品类型'}
                            ,{field: 'unit', title: '单位'}
                            ,{field: 'lastPurchasingPrice', title: '单价'}
                            ,{field: 'num', title: '数量'}
                            ,{field: 'total', title: '总金额'}
                            ,{fixed: 'right', title:'操作', toolbar: '#barDemo'}
                        ]
                    ]
                    ,data:param
                    //,skin: 'line' //表格风格
                    // ,even: true
                    //,page: true //是否显示分页
                    //,limits: [5, 7, 10]
                    //,limit: 5 //每页默认显示的数量
                });
                layui.table.reload('demo',{page:{curr:1}});
                console.log("datatable1");
                console.log(datatable);
                /*      var editFrom = layui.layer.open({
                          title : "编辑学生信息",
                          type : 2,
                          content : "/route/system/useredit",//弹出层页面
                          area: ['800px', '400px'],
                          success : function(layero, index){
                              var body = layui.layer.getChildFrame('body', index);
                              //获取窗口对象
                              var iframeWindow = layero.find('iframe')[0].contentWindow;
                              body.find("#id").val(data.id);
                              body.find("#userName").val(data.userName);
                              // body.find(".studentSex option[value="+data.studentSex+"]").attr("selected","selected");
                              iframeWindow.layui.form.render();
                              iframeWindow.layui.form.render('select');
                          }});*/
            }
        });

        //触发事件
        var active = {
            tabAdd : function() {

                layer.open({
                    type: 1,
                    title: '进货入库商品选择',
                    shadeClose: true,
                    shade: false,
                    resize:true,
                    /*    maxmin: true,  *///开启最大化最小化按钮
                    area: ['800px', '400px'],
                    // content: '/studentAdd.html'
                    content: $('#dg')
                });

            },search:function(){
                var name=$("#studentNameSearch").val();
                console.log("name="+name);
                table.reload('idTest',{
                    method: 'POST'
                    , where: {'name':name},page: {
                        curr: 1 //重新从第 1 页开始
                    }
                });
            },
        };

        $('#studentSearch .layui-btn').on('click', function() {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });


        /* table.on('checkbox(demo2)', function(obj) {
             console.log(obj);
             datapurchase=obj.data;
         });*/


        $(document).on('click','#tabAdd2',function(){
            var checkStatus = table.checkStatus('idTest1')
                ,data = checkStatus.data;
            console.log("data="+data);
            // tabledata=data[0];
            var datajson=JSON.stringify(data);
            param = JSON.parse(datajson);
            datatable=param;
            console.log("param="+param);


            table.render({
                elem: '#demo'
                ,cols:[
                    [ //标题栏
                        {field: 'id', title: 'id', sort: true}
                        ,{field: 'code', title: '商品编码'}
                        ,{field: 'name', title: '商品编码'}
                        ,{field: 'model', title: '商品类型'}
                        ,{field: 'unit', title: '单位'}
                        ,{field: 'lastPurchasingPrice', title: '单价'}
                        ,{field: 'num', title: '数量'}
                        ,{field: 'total', title: '总金额'}
                        ,{fixed: 'right', title:'操作', toolbar: '#barDemo'}
                    ]
                ]
                ,data:param
                //,skin: 'line' //表格风格
                // ,even: true
                //,page: true //是否显示分页
                //,limits: [5, 7, 10]
                //,limit: 5 //每页默认显示的数量
            });
            console.log("加载成功")
            console.log("datajson="+datajson);
            layui.table.reload('demo',{page:{curr:1}});
            /* layer.open({
                 type: 1,
                 title: '商品信息选择',
                 shadeClose: true,
                 shade: false,
                 resize:true,
                 /!*    maxmin: true,  *!///开启最大化最小化按钮
                 area: ['800px', '400px'],
                 // content: '/studentAdd.html'
                 content: $('#dg1')
             });*/
            /*   $("#code1").val(data[0].code);
               $("#name1").val(data[0].name);
               $("#model1").val(data[0].model);
               $("#unit1").val(data[0].unit);
               $("#lastPurchasingPrice1").val(data[0].lastPurchasingPrice);
               $("#inventoryQuantity1").val(data[0].inventoryQuantity);*/

        });

    });
</script>
</html>